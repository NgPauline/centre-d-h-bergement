<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head">
    <title th:text="${pageTitle}">Dossier M√©dical</title>
    <link rel="stylesheet" th:href="@{/css/base/style.css}">
    <link rel="stylesheet" th:href="@{/css/pages/infirmier.css}">
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title" th:text="${pageTitle}">Dossier M√©dical</h1>
            <div class="header-actions">
                <a th:href="@{/infirmier/dossiers-medicaux}" class="btn btn-outline">
                    ‚Üê Retour √† la liste
                </a>
                <a th:if="${dossier != null}" 
                   th:href="@{/infirmier/dossiers-medicaux/{id}/modifier(id=${dossier.id})}" 
                   class="btn btn-primary">
                    ‚úèÔ∏è Modifier
                </a>
            </div>
        </div>

        <!-- Messages flash -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div th:if="${dossier == null}">
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <h3>Aucun dossier m√©dical</h3>
                <p>Ce r√©sident n'a pas encore de dossier m√©dical.</p>
                <a th:href="@{/infirmier/dossiers-medicaux/creer/{id}(id=${resident.id})}" 
                   class="btn btn-primary">
                    üìù Cr√©er le dossier m√©dical
                </a>
            </div>
        </div>

        <div th:if="${dossier != null}">
            <!-- En-t√™te dossier -->
            <div class="dossier-header">
                <h3 th:text="${resident.nomComplet}"></h3>
                <div class="dossier-info">
                    <span>Derni√®re mise √† jour: 
                        <span th:text="${#temporals.format(dossier.derniereMAJ, 'dd/MM/yyyy HH:mm')}"></span>
                    </span>
                </div>
            </div>

            <!-- Informations g√©n√©rales -->
            <div class="card">
                <div class="card-header">
                    <h4>üìã Informations M√©dicales G√©n√©rales</h4>
                </div>
                <div class="card-body">
                    <div class="medical-info-grid">
                        <div class="info-item">
                            <label>Groupe sanguin:</label>
                            <span th:text="${dossier.groupeSanguin} ?: 'Non renseign√©'">-</span>
                        </div>
                        <div class="info-item">
                            <label>Poids:</label>
                            <span th:text="${dossier.poids} ?: 'Non renseign√©'">-</span> kg
                        </div>
                        <div class="info-item">
                            <label>Taille:</label>
                            <span th:text="${dossier.taille} ?: 'Non renseign√©'">-</span> cm
                        </div>
                        <div class="info-item">
                            <label>IMC:</label>
                            <span th:if="${dossier.IMC != null}" 
                                  th:text="${#numbers.formatDecimal(dossier.IMC, 1, 2)}"></span>
                            <span th:if="${dossier.IMC == null}">Non calculable</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ant√©c√©dents -->
            <div class="card">
                <div class="card-header">
                    <h4>üìñ Ant√©c√©dents M√©dicaux</h4>
                </div>
                <div class="card-body">
                    <div class="text-content" th:text="${dossier.antecedents} ?: 'Aucun ant√©c√©dent renseign√©'"></div>
                </div>
            </div>

            <!-- Traitements en cours -->
            <div class="card">
                <div class="card-header">
                    <h4>üíä Traitements en Cours</h4>
                </div>
                <div class="card-body">
                    <div class="text-content" th:text="${dossier.traitementsEnCours} ?: 'Aucun traitement en cours'"></div>
                </div>
            </div>

            <!-- Allergies -->
            <div class="card">
                <div class="card-header">
                    <h4>‚ö†Ô∏è Allergies</h4>
                    <a th:href="@{/infirmier/dossiers-medicaux/{id}/allergie/ajouter(id=${dossier.id})}" 
                       class="btn btn-primary btn-sm">
                        ‚ûï Ajouter une allergie
                    </a>
                </div>
                <div class="card-body">
                    <div th:if="${dossier.allergies.empty}" class="empty-state-small">
                        <p>Aucune allergie enregistr√©e</p>
                    </div>
                    <div th:unless="${dossier.allergies.empty}" class="allergies-container">
                        <div th:each="allergie : ${dossier.allergies}" class="allergie-card">
                            <div class="allergie-header">
                                <h5 th:text="${allergie.substance}"></h5>
                                <span class="badge" 
                                      th:classappend="${allergie.gravite == 'CRITIQUE'} ? 'badge-danger' : 
                                                     ${allergie.gravite == 'SEVERE'} ? 'badge-warning' : 'badge-info'"
                                      th:text="${allergie.gravite}">
                                </span>
                            </div>
                            <div class="allergie-details">
                                <p><strong>Type de r√©action:</strong> <span th:text="${allergie.typeReaction}"></span></p>
                                <p th:if="${allergie.traitement}"><strong>Traitement:</strong> <span th:text="${allergie.traitement}"></span></p>
                            </div>
                            <div class="allergie-actions">
                                <form th:action="@{/infirmier/allergies/{id}/supprimer(id=${allergie.id})}" 
                                      method="post" 
                                      onsubmit="return confirm('Supprimer cette allergie ?')">
                                    <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Supprimer</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pathologies -->
            <div class="card">
                <div class="card-header">
                    <h4>üè• Pathologies</h4>
                    <a th:href="@{/infirmier/dossiers-medicaux/{id}/pathologie/ajouter(id=${dossier.id})}" 
                       class="btn btn-primary btn-sm">
                        ‚ûï Ajouter une pathologie
                    </a>
                </div>
                <div class="card-body">
                    <div th:if="${dossier.pathologies.empty}" class="empty-state-small">
                        <p>Aucune pathologie enregistr√©e</p>
                    </div>
                    <div th:unless="${dossier.pathologies.empty}" class="pathologies-container">
                        <div th:each="pathologie : ${dossier.pathologies}" class="pathologie-card">
                            <div class="pathologie-header">
                                <h5 th:text="${pathologie.nom}"></h5>
                                <span th:if="${pathologie.chronique}" class="badge badge-warning">Chronique</span>
                            </div>
                            <div class="pathologie-details">
                                <p th:if="${pathologie.description}"><strong>Description:</strong> <span th:text="${pathologie.description}"></span></p>
                                <p th:if="${pathologie.traitement}"><strong>Traitement:</strong> <span th:text="${pathologie.traitement}"></span></p>
                            </div>
                            <div class="pathologie-actions">
                                <form th:action="@{/infirmier/pathologies/{id}/supprimer(id=${pathologie.id})}" 
                                      method="post" 
                                      onsubmit="return confirm('Supprimer cette pathologie ?')">
                                    <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Supprimer</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="fragments/footer :: footer"></div>
    <script th:src="@{/js/app.js}"></script>
</body>
</html>